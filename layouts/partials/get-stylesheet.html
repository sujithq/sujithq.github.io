{{- /* Function to get and process a stylesheet resource (SCSS/CSS) */ -}}
{{- $resource := .Resource -}}
{{- if not $resource }}{{- errorf "get-stylesheet.html: missing Resource" -}}{{ end -}}

{{- $isProduction := eq hugo.Environment "production" -}}
{{- $processed := $resource -}}

{{- /* Detect media type reliably; RelPermalink can be empty for assets */ -}}
{{- $mt := $resource.MediaType -}}
{{- $sub := cond (ne $mt nil) $mt.SubType "" -}}
{{- $isScss := or (eq $sub "scss") (eq $sub "x-scss") (eq $sub "sass") (eq $sub "x-sass") -}}

{{- /* If SCSS/SASS, compile to CSS first */ -}}
{{- if $isScss -}}
  {{- $processed = $processed | toCSS -}}
{{- end -}}

{{- /* Only run PostCSS on CSS assets (after toCSS when needed) */ -}}
{{- if and $isProduction (eq $processed.MediaType.SubType "css") -}}
  {{- $processed = $processed | css.PostCSS -}}
{{- end -}}

{{- /* Minify and fingerprint CSS; preserve media type */ -}}
{{- if ne $processed.MediaType.SubType "css" -}}
  {{- /* Failsafe: attempt to compile any lingering SCSS/SASS */ -}}
  {{- with $processed | toCSS -}}
    {{- $processed = . -}}
  {{- end -}}
{{- end -}}

{{- if eq $processed.MediaType.SubType "css" -}}
  {{- $processed = $processed | minify | fingerprint -}}
{{- else -}}
  {{- /* Fallback: just fingerprint to keep stable URLs */ -}}
  {{- $processed = $processed | fingerprint -}}
{{- end -}}

{{- return $processed -}}
